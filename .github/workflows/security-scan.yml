name: Security Scan

on:
  schedule:
    # Run security scan daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - dependencies
          - infrastructure

jobs:
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ” Dependency Security Scan
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'dependencies'
        run: |
          echo "ğŸ” Scanning dependencies for vulnerabilities..."
          npm audit --audit-level=moderate
          echo "âœ… Dependency scan completed"

      - name: ğŸ—ï¸ Build for Infrastructure Scan
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'infrastructure'
        run: |
          npm run build
          npm run synth

      - name: ğŸ”’ Infrastructure Security Scan
        if: github.event.inputs.scan_type == 'full' || github.event.inputs.scan_type == 'infrastructure'
        run: |
          echo "ğŸ”’ Scanning infrastructure for security issues..."
          
          if [ -f "cdk.out/threat-model.json" ]; then
            CRITICAL_THREATS=$(jq '[.threats[] | select(.risk == "Critical")] | length' cdk.out/threat-model.json)
            HIGH_THREATS=$(jq '[.threats[] | select(.risk == "High")] | length' cdk.out/threat-model.json)
            
            echo "ğŸ“Š Security Scan Results:"
            echo "  ğŸ”´ Critical Threats: $CRITICAL_THREATS"
            echo "  ğŸŸ  High Risk Threats: $HIGH_THREATS"
            
            if [ "$CRITICAL_THREATS" -gt 0 ]; then
              echo "âš ï¸ Critical security issues found:"
              jq '.threats[] | select(.risk == "Critical") | {id, title, scenario}' cdk.out/threat-model.json
            fi
            
            # Create security report
            echo "# Security Scan Report" > security-report.md
            echo "" >> security-report.md
            echo "**Scan Date:** $(date)" >> security-report.md
            echo "**Critical Threats:** $CRITICAL_THREATS" >> security-report.md
            echo "**High Risk Threats:** $HIGH_THREATS" >> security-report.md
            echo "" >> security-report.md
            
            if [ "$CRITICAL_THREATS" -gt 0 ]; then
              echo "## Critical Threats" >> security-report.md
              jq -r '.threats[] | select(.risk == "Critical") | "- **\(.id)**: \(.title)"' cdk.out/threat-model.json >> security-report.md
            fi
          else
            echo "âš ï¸ No threat model found - infrastructure scan skipped"
          fi

      - name: ğŸ“¤ Upload Security Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ github.run_id }}
          path: |
            security-report.md
            cdk.out/threat-model.json
          retention-days: 90

      - name: ğŸ“Š Security Summary
        run: |
          echo "ğŸ”’ Security scan completed"
          echo "ğŸ“‹ Report available in artifacts"