name: Deploy Lattice Website to AWS

on:
  push:
    branches: [main]
    paths: ['website/**', 'website-deployment-stack.ts', 'bin/deploy-website.ts']
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'prod'
        type: choice
        options:
        - prod
        - staging

env:
  NODE_VERSION: '18'
  AWS_DEFAULT_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:
  deploy-website:
    name: ðŸŒ Deploy Website to AWS
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: ${{ github.event.inputs.environment || 'prod' }}
      url: ${{ steps.deploy.outputs.website-url }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install dependencies
        run: |
          npm ci
          npm install -g aws-cdk

      - name: ðŸ—ï¸ Build project
        run: npm run build

      - name: ðŸ”‘ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: LatticeWebsiteDeployment
          aws-region: ${{ env.AWS_DEFAULT_REGION }}

      - name: ðŸ”§ Bootstrap CDK (if needed)
        run: |
          if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region ${{ env.AWS_DEFAULT_REGION }} 2>/dev/null; then
            echo "ðŸš€ Bootstrapping CDK..."
            cdk bootstrap aws://$(aws sts get-caller-identity --query Account --output text)/${{ env.AWS_DEFAULT_REGION }}
          else
            echo "âœ… CDK already bootstrapped"
          fi

      - name: ðŸ”„ Synthesize CDK stack
        run: |
          cdk synth -a "node lib/deploy-website.js" LatticeWebsite-${{ github.event.inputs.environment || 'prod' }} \
            --context environment=${{ github.event.inputs.environment || 'prod' }}

      - name: ðŸš€ Deploy to AWS
        id: deploy
        run: |
          ENVIRONMENT=${{ github.event.inputs.environment || 'prod' }}
          STACK_NAME="LatticeWebsite-${ENVIRONMENT}"
          
          echo "ðŸš€ Deploying ${STACK_NAME}..."
          
          cdk deploy -a "node lib/deploy-website.js" $STACK_NAME \
            --context environment=$ENVIRONMENT \
            --require-approval never \
            --outputs-file website-outputs.json
          
          # Extract outputs
          WEBSITE_URL=$(cat website-outputs.json | jq -r ".[\"$STACK_NAME\"].WebsiteURL")
          DISTRIBUTION_ID=$(cat website-outputs.json | jq -r ".[\"$STACK_NAME\"].DistributionId")
          
          echo "website-url=$WEBSITE_URL" >> $GITHUB_OUTPUT
          echo "distribution-id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Website URL: $WEBSITE_URL"

      - name: ðŸ§ª Test website
        run: |
          WEBSITE_URL="${{ steps.deploy.outputs.website-url }}"
          echo "ðŸ§ª Testing website at $WEBSITE_URL"
          
          # Wait for CloudFront to propagate
          sleep 30
          
          # Test main page
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Main page is accessible"
          else
            echo "âŒ Main page returned status: $HTTP_STATUS"
            exit 1
          fi
          
          # Test demo page
          DEMO_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$WEBSITE_URL/real-lattice-demo.html")
          if [ "$DEMO_STATUS" = "200" ]; then
            echo "âœ… Demo page is accessible"
          else
            echo "âš ï¸ Demo page returned status: $DEMO_STATUS"
          fi

      - name: ðŸ“Š Update deployment status
        run: |
          cat > deployment-summary.json << EOF
          {
            "environment": "${{ github.event.inputs.environment || 'prod' }}",
            "websiteUrl": "${{ steps.deploy.outputs.website-url }}",
            "distributionId": "${{ steps.deploy.outputs.distribution-id }}",
            "deployedAt": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit": "${{ github.sha }}",
            "workflow": "${{ github.run_id }}"
          }
          EOF
          
          echo "ðŸ“‹ Deployment Summary:"
          cat deployment-summary.json | jq .

      - name: ðŸ’¬ Comment on commit (if push)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const websiteUrl = '${{ steps.deploy.outputs.website-url }}';
            const environment = '${{ github.event.inputs.environment || 'prod' }}';
            
            const body = `
            ## ðŸš€ Lattice Website Deployed Successfully
            
            **Environment:** ${environment}
            **Website URL:** ${websiteUrl}
            **Commit:** ${context.sha.substring(0, 7)}
            
            ### ðŸŽ¯ What's Live:
            - âœ… Landing page with full feature showcase
            - âœ… Interactive demo and real Lattice framework demo
            - âœ… Documentation and pricing pages
            - âœ… Optimized CloudFront CDN delivery
            - âœ… HTTPS with automatic SSL certificates
            
            ### ðŸ“Š Performance:
            - ðŸŒ Global CDN with edge caching
            - âš¡ Compressed assets and optimized delivery
            - ðŸ”’ Security headers and best practices
            
            **ðŸŒ Visit your live site:** ${websiteUrl}
            `;
            
            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: body
            });

      - name: ðŸ“¤ Upload deployment artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lattice-website-deployment-${{ github.run_id }}
          path: |
            website-outputs.json
            deployment-summary.json
            cdk.out/
          retention-days: 30